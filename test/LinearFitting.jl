using Test

using EquationsOfState.LinearFitting

@testset "Test data from Pymatgen" begin
    volumes = [
        25.987454833,
        26.9045702104,
        27.8430241908,
        28.8029649591,
        29.7848370694,
        30.7887887064,
        31.814968055,
        32.8638196693,
        33.9353435494,
        35.0299842495,
        36.1477417695,
        37.2892088485,
        38.4543854865,
        39.6437162376,
        40.857201102,
        42.095136449,
        43.3579668329,
        44.6456922537,
        45.9587572656,
        47.2973100535,
        48.6614988019,
        50.0517680652,
        51.4682660281,
        52.9112890601,
        54.3808371612,
        55.8775030703,
        57.4014349722,
        58.9526328669,
    ]
    v0 = 40.98926572870838
    @test map(v -> EulerianStrain()(v0, v), volumes) ≈ [
        0.17749734613767998,
        0.16201229839015363,
        0.14705196468522874,
        0.13259433633439055,
        0.11861428460608225,
        0.10509239492761757,
        0.09201008130906252,
        0.07934607736917354,
        0.06708557020358508,
        0.0552093893237503,
        0.043704151717372075,
        0.032551138219835574,
        0.021738453213956288,
        0.011250631487461304,
        0.0010768691828133559,
        -0.00879571243518995,
        -0.01838039465214164,
        -0.02768646727024454,
        -0.03672601609939291,
        -0.04550846145018128,
        -0.05404287277132974,
        -0.06233970600633609,
        -0.07040712280723271,
        -0.07825377702272912,
        -0.08588638996615916,
        -0.09331442415000685,
        -0.10054463011940301,
        -0.1075828678792159,
    ]
    @test [LagrangianStrain()(v0, v) for v in volumes] ≈ [
        -0.13099486451833953,
        -0.12236351105872695,
        -0.11363226812607319,
        -0.10480202613156259,
        -0.09587095509895383,
        -0.08683995684674645,
        -0.07770989398154193,
        -0.06847899767396914,
        -0.059149424468252,
        -0.04971943052962041,
        -0.04019111457888069,
        -0.030561514081675456,
        -0.020832711371037982,
        -0.011003048988641961,
        -0.0010745548727579268,
        0.008953212194864557,
        0.0190818588446644,
        0.029309415622954416,
        0.039637468728734304,
        0.050065246093897176,
        0.06059200478213067,
        0.0712192845248587,
        0.08194633401200402,
        0.09277353626347284,
        0.10369906697722475,
        0.11472551485871496,
        0.125852144820906,
        0.13707718021610538,
    ]
    @test [NaturalStrain()(v0, v) for v in volumes] ≈ [
        -0.15189876859201823,
        -0.14033801748544264,
        -0.1289092546069999,
        -0.1176106297063706,
        -0.10643692669611844,
        -0.09538653341846574,
        -0.08445778277754971,
        -0.07364595812672871,
        -0.06295105569265277,
        -0.05236861111679098,
        -0.04189858087249365,
        -0.03153541438302606,
        -0.02127915820568489,
        -0.011125922058677679,
        -0.0010757111979426712,
        0.008873996435816848,
        0.018726748238692272,
        0.028482534552264627,
        0.0381447307354657,
        0.04771440101503085,
        0.05719263915631435,
        0.06658253672817539,
        0.07588506772815591,
        0.0851021663162455,
        0.09423387093583208,
        0.10328387622610548,
        0.11225302719931324,
        0.1211413559225737,
    ]
    @test [InfinitesimalStrain()(v0, v) for v in volumes] ≈ [
        -0.1640423928171002,
        -0.1506626772344306,
        -0.13758688871244362,
        -0.12480606002491879,
        -0.1123077673073063,
        -0.10008399218206754,
        -0.0881269055666829,
        -0.07642563827621052,
        -0.06497471350599215,
        -0.05376410009427657,
        -0.04278871466598844,
        -0.0320379239348092,
        -0.021507173948334346,
        -0.011188045308548222,
        -0.0010762899827498895,
        0.00883473873948748,
        0.01855249213433896,
        0.02808073099690478,
        0.03742638317829727,
        0.046593960004638224,
        0.05558787891231487,
        0.06441430751249311,
        0.07307726622682587,
        0.08158155182153393,
        0.08993010154841308,
        0.09812908257335062,
        0.10618193139700183,
        0.11409127770318894,
    ]
end

@testset "Test strain-volume-derivative" begin
    volumes = [
        25.987454833,
        26.9045702104,
        27.8430241908,
        28.8029649591,
        29.7848370694,
        30.7887887064,
        31.814968055,
        32.8638196693,
        33.9353435494,
        35.0299842495,
        36.1477417695,
        37.2892088485,
        38.4543854865,
        39.6437162376,
        40.857201102,
        42.095136449,
        43.3579668329,
        44.6456922537,
        45.9587572656,
        47.2973100535,
        48.6614988019,
        50.0517680652,
        51.4682660281,
        52.9112890601,
        54.3808371612,
        55.8775030703,
        57.4014349722,
        58.9526328669,
    ]
    v0 = 40.98926572870838
    @test [strain_volume_derivative(EulerianStrain(), v0, v, 3) for v in volumes] ≈ [
        -0.00025163164656036914,
        -0.00022158317701314234,
        -0.0001954064296869249,
        -0.00017256893337511754,
        -0.00015261005948744114,
        -0.00013514276136071226,
        -0.00011983495896811362,
        -0.00010639785139417004,
        -9.458902516425933e-5,
        -8.419491823560175e-5,
        -7.503571748024374e-5,
        -6.695156194310254e-5,
        -5.980866702052554e-5,
        -5.348840953851233e-5,
        -4.789028506457302e-5,
        -4.2925492613058147e-5,
        -3.85164573279167e-5,
        -3.459717265567486e-5,
        -3.110870879523787e-5,
        -2.8000473828556818e-5,
        -2.5228159545528874e-5,
        -2.275242969867225e-5,
        -2.0539381634855355e-5,
        -1.855902166896191e-5,
        -1.6785363112484185e-5,
        -1.5194859884358581e-5,
        -1.3767304534537318e-5,
        -1.2484962604556655e-5,
    ]
    @test [strain_volume_derivative(LagrangianStrain(), v0, v, 3) for v in volumes] ≈ [
        -4.360792585446927e-5,
        -4.021795998862133e-5,
        -3.7125806529670504e-5,
        -3.430262724447532e-5,
        -3.172185978064063e-5,
        -2.9360589247189284e-5,
        -2.719823329453535e-5,
        -2.5215761270023045e-5,
        -2.3396932620829496e-5,
        -2.172639361674028e-5,
        -2.0191013020817355e-5,
        -1.8778177794469247e-5,
        -1.7477278166117428e-5,
        -1.6278235883744374e-5,
        -1.5172392867363944e-5,
        -1.4151626497343523e-5,
        -1.3208496564809248e-5,
        -1.2336591903572137e-5,
        -1.1529793498552908e-5,
        -1.0782740265865238e-5,
        -1.009054720444801e-5,
        -9.448630234274912e-6,
        -8.852961760583228e-6,
        -8.299807942932397e-6,
        -7.78586914649821e-6,
        -7.307932527332951e-6,
        -6.863217457745042e-6,
        -6.449212613211634e-6,
    ]
    @test [strain_volume_derivative(NaturalStrain(), v0, v, 3) for v in volumes] ≈ [
        0.00011395640842831919,
        0.00010269559592471744,
        9.265754335710983e-5,
        8.369864119123017e-5,
        7.569101157907677e-5,
        6.852549573283301e-5,
        6.210628060176279e-5,
        5.634765917870933e-5,
        5.117681395143497e-5,
        4.6527548395465794e-5,
        4.234347362622052e-5,
        3.857273983853629e-5,
        3.517161972472347e-5,
        3.2100139446683775e-5,
        2.9324064018820016e-5,
        2.681230993011352e-5,
        2.4537102053587615e-5,
        2.2474565886168472e-5,
        2.0602748703699993e-5,
        1.890256196526239e-5,
        1.7356955567635e-5,
        1.5950405389513548e-5,
        1.466936735556791e-5,
        1.3501591655278468e-5,
        1.2436332606671682e-5,
        1.1463547171440715e-5,
        1.0574546405738849e-5,
        9.761585855581402e-6,
    ]
    @test [strain_volume_derivative(InfinitesimalStrain(), v0, v, 3) for v in volumes] ≈ [
        0.00017195382081596378,
        0.00015318072693119346,
        0.0001366374157858279,
        0.00012203947625819057,
        0.00010913738901171863,
        9.77197419230021e-5,
        8.76030749059566e-5,
        7.862563981068296e-5,
        7.065075730232455e-5,
        6.355618910218268e-5,
        5.723834723338108e-5,
        5.160365044520063e-5,
        4.657341353283599e-5,
        4.207684089417924e-5,
        3.80535882418961e-5,
        3.444963171076881e-5,
        3.1217248819476426e-5,
        2.8315601024208774e-5,
        2.5707710435800747e-5,
        2.3361614304347095e-5,
        2.1249043437552616e-5,
        1.9344592130116945e-5,
        1.7626220489559587e-5,
        1.6074217776270604e-5,
        1.4671393271712412e-5,
        1.3401940487277108e-5,
        1.2252230465391096e-5,
        1.121020710562245e-5,
    ]
end
