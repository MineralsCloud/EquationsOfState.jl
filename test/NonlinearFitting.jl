using Test

using Unitful, UnitfulAtomic

using EquationsOfState
using EquationsOfState.Collections
using EquationsOfState.NonlinearFitting

@testset "Test fitting energy with different element types" begin
    result = BirchMurnaghan3rd(
        0.0057009512119028044,
        103.58772269057364,
        -144.45152457521132,
        -40.31992619868024,
    ) |> Collections.fieldvalues
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan3rd(1, 2, 3.0, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-5,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan3rd(1, 2, 3, 0),
            [1, 2, 3, 4, 5.0],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-5,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan3rd(1, 2, 3.0, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7.0],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-5,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan3rd(1, 2, 3, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-5,
    )
end

@testset "Test fitting pressure with different element types" begin
    result = BirchMurnaghan3rd(
        1.1024687826597717,
        29.30861698140365,
        12.689089871112746,
        0.0,
    ) |> Collections.fieldvalues
    @test isapprox(
        lsqfit(
            PressureForm(),
            BirchMurnaghan3rd(1, 2, 3.0, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-6,
    )
    @test isapprox(
        lsqfit(
            PressureForm(),
            BirchMurnaghan3rd(1, 2, 3, 0),
            [1, 2, 3, 4, 5.0],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-6,
    )
    @test isapprox(
        lsqfit(
            PressureForm(),
            BirchMurnaghan3rd(1, 2, 3.0, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7.0],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-6,
    )
    @test isapprox(
        lsqfit(
            PressureForm(),
            BirchMurnaghan3rd(1, 2, 3, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-6,
    )
end

@testset "Test fitting bulk modulus with different element types" begin
    result = BirchMurnaghan3rd(
        7.218928431312577,
        5.007900469653902,
        4.06037725509478,
        0.0,
    ) |> Collections.fieldvalues
    @test isapprox(
        lsqfit(
            BulkModulusForm(),
            BirchMurnaghan3rd(1, 2, 3.0, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-5,
    )
    @test isapprox(
        lsqfit(
            BulkModulusForm(),
            BirchMurnaghan3rd(1, 2, 3, 0),
            [1, 2, 3, 4, 5.0],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-5,
    )
    @test isapprox(
        lsqfit(
            BulkModulusForm(),
            BirchMurnaghan3rd(1, 2, 3.0, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7.0],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-5,
    )
    @test isapprox(
        lsqfit(
            BulkModulusForm(),
            BirchMurnaghan3rd(1, 2, 3, 0),
            [1, 2, 3, 4, 5],
            [5, 6, 9, 8, 7],
        ) |> Collections.fieldvalues,
        result;
        atol = 1e-5,
    )
end

# Data in the following tests are from
# https://github.com/materialsproject/pymatgen/blob/1f0957b8525ddc7d12ea348a19caecebe6c7ff34/pymatgen/analysis/tests/test_eos.py
@testset "Test data from Pymatgen" begin
    volumes = [
        25.987454833,
        26.9045702104,
        27.8430241908,
        28.8029649591,
        29.7848370694,
        30.7887887064,
        31.814968055,
        32.8638196693,
        33.9353435494,
        35.0299842495,
        36.1477417695,
        37.2892088485,
        38.4543854865,
        39.6437162376,
        40.857201102,
        42.095136449,
        43.3579668329,
        44.6456922537,
        45.9587572656,
        47.2973100535,
        48.6614988019,
        50.0517680652,
        51.4682660281,
        52.9112890601,
        54.3808371612,
        55.8775030703,
        57.4014349722,
        58.9526328669,
    ]
    energies = [
        -7.63622156576,
        -8.16831294894,
        -8.63871612686,
        -9.05181213218,
        -9.41170988374,
        -9.72238224345,
        -9.98744832526,
        -10.210309552,
        -10.3943401353,
        -10.5427238068,
        -10.6584266073,
        -10.7442240979,
        -10.8027285713,
        -10.8363890521,
        -10.8474912964,
        -10.838157792,
        -10.8103477586,
        -10.7659387815,
        -10.7066179666,
        -10.6339907853,
        -10.5495538639,
        -10.4546677714,
        -10.3506386542,
        -10.2386366017,
        -10.1197772808,
        -9.99504030111,
        -9.86535084973,
        -9.73155247952,
    ]
    @test isapprox(
        lsqfit(EnergyForm(), BirchMurnaghan3rd(40, 0.5, 4, 0), volumes, energies) |> Collections.fieldvalues,
        BirchMurnaghan3rd(
            40.98926572528106,
            0.5369258245417454,
            4.178644235500821,
            -10.842803908240892,
        ) |> Collections.fieldvalues,
    )
    @test isapprox(
        lsqfit(EnergyForm(), Murnaghan(41, 0.5, 4, 0), volumes, energies) |> Collections.fieldvalues,
        Murnaghan(
            41.13757930387086,
            0.5144967693786603,
            3.9123862262572264,
            -10.836794514626673,
        ) |> Collections.fieldvalues,
    )
    @test isapprox(
        lsqfit(EnergyForm(), PoirierTarantola3rd(41, 0.5, 4, 0), volumes, energies) |> Collections.fieldvalues,
        PoirierTarantola3rd(
            40.86770643373908,
            0.5667729960804602,
            4.331688936974368,
            -10.851486685041658,
        ) |> Collections.fieldvalues,
    )
    @test isapprox(
        lsqfit(EnergyForm(), Vinet(41, 0.5, 4, 0), volumes, energies) |> Collections.fieldvalues,
        Vinet(
            40.916875663779784,
            0.5493839425156859,
            4.3051929654936885,
            -10.846160810560756,
        ) |> Collections.fieldvalues,
    )
    # 'deltafactor': {'b0': 0.5369258245611414,
#             'b1': 4.178644231924639,
#             'e0': -10.842803908299294,
#             'v0': 40.989265727927936},
# 'numerical_eos': {'b0': 0.5557257614101998,
#             'b1': 4.344039148405489,
#             'e0': -10.847490826530702,
#             'v0': 40.857200064982536},
# }
end

@testset "Test Mg dataset" begin
    mp153_volumes = [
        16.69182365,
        17.25441763,
        17.82951915,
        30.47573817,
        18.41725977,
        29.65211363,
        28.84346369,
        19.01777055,
        28.04965916,
        19.63120886,
        27.27053682,
        26.5059864,
        20.25769112,
        25.75586879,
        20.89736201,
        25.02003097,
        21.55035204,
        24.29834347,
        22.21681221,
        23.59066888,
        22.89687316,
    ]

    mp153_energies = [
        -1.269884575,
        -1.339411225,
        -1.39879471,
        -1.424480995,
        -1.44884184,
        -1.45297499,
        -1.4796246,
        -1.49033594,
        -1.504198485,
        -1.52397006,
        -1.5264432,
        -1.54609291,
        -1.550269435,
        -1.56284009,
        -1.569937375,
        -1.576420935,
        -1.583470925,
        -1.58647189,
        -1.591436505,
        -1.592563495,
        -1.594347355,
    ]

    mp153_known_energies_vinet = [
        -1.270038831,
        -1.339366487,
        -1.398683238,
        -1.424556061,
        -1.448746649,
        -1.453000456,
        -1.479614511,
        -1.490266797,
        -1.504163502,
        -1.523910268,
        -1.526395734,
        -1.546038792,
        -1.550298657,
        -1.562800797,
        -1.570015274,
        -1.576368392,
        -1.583605186,
        -1.586404575,
        -1.591578378,
        -1.592547954,
        -1.594410995,
    ]

    fitted_eos = lsqfit(EnergyForm(), Vinet(23, 0.5, 4, -2), mp153_volumes, mp153_energies)
    @test isapprox(
        fitted_eos |> Collections.fieldvalues,
        Vinet(
            22.95764559358769,
            0.2257091141420788,
            4.060543387224629,
            -1.5944292606251582,
        ) |> Collections.fieldvalues,
    )
    @test isapprox(
        map(apply(EnergyForm(), fitted_eos), mp153_volumes),
        mp153_known_energies_vinet;
        atol = 1e-5,
    )
end

@testset "Test Si dataset" begin
    mp149_volumes = [
        15.40611854,
        14.90378698,
        16.44439516,
        21.0636307,
        17.52829835,
        16.98058208,
        18.08767363,
        18.65882487,
        19.83693435,
        15.91961152,
        22.33987173,
        21.69548924,
        22.99688883,
        23.66666322,
        20.44414922,
        25.75374305,
        19.24187473,
        24.34931029,
        25.04496106,
        27.21116571,
        26.4757653,
    ]

    mp149_energies = [
        -4.866909695,
        -4.7120965,
        -5.10921253,
        -5.42036228,
        -5.27448405,
        -5.200810795,
        -5.331915665,
        -5.3744186,
        -5.420058145,
        -4.99862686,
        -5.3836163,
        -5.40610838,
        -5.353700425,
        -5.31714654,
        -5.425263555,
        -5.174988295,
        -5.403353105,
        -5.27481447,
        -5.227210275,
        -5.058992615,
        -5.118805775,
    ]

    mp149_known_energies_vinet = [
        -4.866834585,
        -4.711786499,
        -5.109642598,
        -5.420093739,
        -5.274605844,
        -5.201025714,
        -5.331899365,
        -5.374315789,
        -5.419671568,
        -4.998827503,
        -5.383703409,
        -5.406038887,
        -5.353926272,
        -5.317484252,
        -5.424963418,
        -5.175090887,
        -5.403166824,
        -5.275096644,
        -5.227427635,
        -5.058639193,
        -5.118654229,
    ]

    fitted_eos = lsqfit(EnergyForm(), Vinet(20, 0.5, 4, -5), mp149_volumes, mp149_energies)
    @test isapprox(
        fitted_eos |> Collections.fieldvalues,
        Vinet(
            20.446696754873944,
            0.5516638521306302,
            4.324373909783161,
            -5.424963389876503,
        ) |> Collections.fieldvalues,
    )
    @test isapprox(
        map(apply(EnergyForm(), fitted_eos), mp149_volumes),
        mp149_known_energies_vinet;
        atol = 1e-5,
    )
end

@testset "Test Ti dataset" begin
    mp72_volumes = [
        12.49233296,
        12.91339188,
        13.34380224,
        22.80836212,
        22.19195533,
        13.78367177,
        21.58675559,
        14.23310328,
        20.99266009,
        20.4095592,
        14.69220297,
        19.83736385,
        15.16106697,
        19.2759643,
        15.63980711,
        18.72525771,
        16.12851491,
        18.18514127,
        16.62729878,
        17.65550599,
        17.13626153,
    ]

    mp72_energies = [
        -7.189983803,
        -7.33985647,
        -7.468745423,
        -7.47892835,
        -7.54945107,
        -7.578012237,
        -7.61513166,
        -7.66891898,
        -7.67549721,
        -7.73000681,
        -7.74290386,
        -7.77803379,
        -7.801246383,
        -7.818964483,
        -7.84488189,
        -7.85211192,
        -7.87486651,
        -7.876767777,
        -7.892161533,
        -7.892199957,
        -7.897605303,
    ]

    mp72_known_energies_vinet = [
        -7.189911138,
        -7.339810181,
        -7.468716095,
        -7.478678021,
        -7.549402394,
        -7.578034391,
        -7.615240977,
        -7.669091347,
        -7.675683891,
        -7.730188653,
        -7.74314028,
        -7.778175824,
        -7.801363213,
        -7.819030923,
        -7.844878053,
        -7.852099741,
        -7.874737806,
        -7.876686864,
        -7.891937429,
        -7.892053535,
        -7.897414664,
    ]

    fitted_eos = lsqfit(EnergyForm(), Vinet(17, 0.5, 4, -7), mp72_volumes, mp72_energies)
    @test isapprox(
        fitted_eos |> Collections.fieldvalues,
        Vinet(
            17.13223026131245,
            0.7029766224730147,
            3.6388077563621812,
            -7.897414959124461,
        ) |> Collections.fieldvalues,
    )
    @test isapprox(
        map(apply(EnergyForm(), fitted_eos), mp72_volumes),
        mp72_known_energies_vinet;
        atol = 1e-5,
    )
end

@testset "`Test w2k-lda-na.dat` from `Gibbs2`" begin
    data = [
        159.9086 -323.4078898
        162.5738 -323.4089153
        165.2389 -323.4098546
        167.9041 -323.410722
        170.5692 -323.4115195
        173.2344 -323.4122481
        175.8995 -323.4129189
        178.5647 -323.413528
        181.2298 -323.4140871
        183.8949 -323.4145889
        186.5601 -323.4150471
        189.2252 -323.415459
        191.8904 -323.4158302
        194.5555 -323.4161579
        197.2207 -323.4164498
        199.8858 -323.4167071
        202.551 -323.4169305
        205.2161 -323.4171194
        207.8812 -323.4172809
        210.5464 -323.4174144
        213.2115 -323.4175216
        215.8767 -323.4176029
        218.5418 -323.417661
        221.207 -323.4176975
        223.8721 -323.41771
        226.5373 -323.4177051
        229.2024 -323.417682
        231.8675 -323.4176375
        234.5327 -323.417579
        237.1978 -323.4175048
        239.863 -323.4174142
        242.5281 -323.4173101
        245.1933 -323.4171922
        247.8584 -323.4170611
        250.5236 -323.4169184
        253.1887 -323.4167647
        255.8538 -323.4166002
        258.519 -323.4164244
        261.1841 -323.4162386
        263.8493 -323.4160446
        266.5144 -323.4158421
        269.1796 -323.4156312
        271.8447 -323.4154125
        274.5098 -323.4151861
        277.175 -323.4149528
        279.8401 -323.4147131
        282.5053 -323.414467
        285.1704 -323.414215
        287.8356 -323.4139583
        290.5007 -323.4136953
        293.1659 -323.4134285
        295.831 -323.4131559
        298.4961 -323.4128797
        301.1613 -323.4125984
        303.8264 -323.4123147
        306.4916 -323.4120269
        309.1567 -323.411736
        311.8219 -323.4114399
        314.487 -323.4111421
        317.1522 -323.4108418
        319.8173 -323.4105393
    ]
    volumes = data[:, 1]  # unit: bohr^3
    energies = data[:, 2]  # unit: Rydberg
    @test isapprox(
        lsqfit(EnergyForm(), Murnaghan(224, 0.006, 4, -323), volumes, energies) |> Collections.fieldvalues,
        Murnaghan(224.501825, 0.00060479524074699499, 3.723835, -323.417686) |> Collections.fieldvalues;
        atol = 1e-5,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan2nd(224, 0.0006, -323),
            volumes,
            energies,
        ) |> Collections.fieldvalues,
        BirchMurnaghan2nd(
            223.7192539523166,
            0.0006268341030294977,
            -323.4177121144877,
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test lsqfit(
        EnergyForm(),
        BirchMurnaghan3rd(224, 0.0006, 4, -323),
        volumes,
        energies,
    ) |> Collections.fieldvalues ≈ BirchMurnaghan3rd(
        224.444565,
        0.00062506191050572675,
        3.740369,
        -323.417714,
    ) |> Collections.fieldvalues
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan4th(224, 0.0006, 4, -5460, -323),
            volumes,
            energies,
        ) |> Collections.fieldvalues,
        BirchMurnaghan4th(
            224.45756238103118,
            0.0006229382380931005,
            3.730991532958105,
            -5322.696706065215,
            -323.4177113158582,
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test lsqfit(
        EnergyForm(),
        Vinet(224, 0.0006, 4, -323),
        volumes,
        energies,
    ) |> Collections.fieldvalues ≈ Vinet(
        224.45278665796354,
        0.0006313500637481759,
        3.7312381477678853,
        -323.4177229576912,
    ) |> Collections.fieldvalues
    @test isapprox(
        lsqfit(
            EnergyForm(),
            PoirierTarantola3rd(100, 0.0006, 3.7, -323),
            volumes,
            energies,
        ) |> Collections.fieldvalues,
        PoirierTarantola3rd(224.509208, 0.000635892264159838, 3.690448, -323.41773) |> Collections.fieldvalues;
        atol = 1e-5,
    )
    # @test lsqfit(EnergyForm(), PoirierTarantola4th(220, 0.0006, 3.7, -5500, -323), volumes, energies; lower = Float64[220, 0, 3, -6000, -400], upper = Float64[300, 0.01, 5, -5000, -300]) ≈ PoirierTarantola4th(224.430182, 0.0006232241765069493, 3.758360, -5493.859729817176, -323.417712)
end

@testset "`Test w2k-lda-na.dat` from `Gibbs2` with units" begin
    data = [
        159.9086 -323.4078898
        162.5738 -323.4089153
        165.2389 -323.4098546
        167.9041 -323.410722
        170.5692 -323.4115195
        173.2344 -323.4122481
        175.8995 -323.4129189
        178.5647 -323.413528
        181.2298 -323.4140871
        183.8949 -323.4145889
        186.5601 -323.4150471
        189.2252 -323.415459
        191.8904 -323.4158302
        194.5555 -323.4161579
        197.2207 -323.4164498
        199.8858 -323.4167071
        202.551 -323.4169305
        205.2161 -323.4171194
        207.8812 -323.4172809
        210.5464 -323.4174144
        213.2115 -323.4175216
        215.8767 -323.4176029
        218.5418 -323.417661
        221.207 -323.4176975
        223.8721 -323.41771
        226.5373 -323.4177051
        229.2024 -323.417682
        231.8675 -323.4176375
        234.5327 -323.417579
        237.1978 -323.4175048
        239.863 -323.4174142
        242.5281 -323.4173101
        245.1933 -323.4171922
        247.8584 -323.4170611
        250.5236 -323.4169184
        253.1887 -323.4167647
        255.8538 -323.4166002
        258.519 -323.4164244
        261.1841 -323.4162386
        263.8493 -323.4160446
        266.5144 -323.4158421
        269.1796 -323.4156312
        271.8447 -323.4154125
        274.5098 -323.4151861
        277.175 -323.4149528
        279.8401 -323.4147131
        282.5053 -323.414467
        285.1704 -323.414215
        287.8356 -323.4139583
        290.5007 -323.4136953
        293.1659 -323.4134285
        295.831 -323.4131559
        298.4961 -323.4128797
        301.1613 -323.4125984
        303.8264 -323.4123147
        306.4916 -323.4120269
        309.1567 -323.411736
        311.8219 -323.4114399
        314.487 -323.4111421
        317.1522 -323.4108418
        319.8173 -323.4105393
    ]
    volumes = data[:, 1] .* u"bohr^3"
    energies = data[:, 2] .* u"Ry"
    fitted_eos = lsqfit(
        EnergyForm(),
        BirchMurnaghan3rd(224 * u"bohr^3", 0.0006 * u"Ry/bohr^3", 4, -323 * u"Ry"),
        volumes,
        energies,
    )
    @test ustrip.(fitted_eos |> Collections.fieldvalues) ≈
    ustrip.(
        BirchMurnaghan3rd(
            224.444565 * u"bohr^3",
            0.00062506191050572675 * u"Ry/bohr^3",
            3.740369,
            -323.417714 * u"Ry",
        ) |> Collections.fieldvalues
    )
    @test ustrip.(
        lsqfit(EnergyForm(), BirchMurnaghan3rd(224u"bohr^3", 10u"GPa", 3.75, -161u"hartree"), volumes, energies) |> Collections.fieldvalues
    ) ≈
    ustrip.(
        BirchMurnaghan3rd(224.4445656763778u"bohr^3", 9.194980249913018u"GPa", 3.7403684211716297, -161.70885710742223u"hartree") |> Collections.fieldvalues
    )
end

@testset "`Test w2k-lda-k.dat` from `Gibbs2`" begin
    vs = [
        243.6753
        246.941
        250.2358
        253.5598
        256.9131
        260.2958
        263.7081
        267.1501
        270.6219
        274.1236
        277.6555
        281.2175
        284.8099
        288.4327
        292.0861
        295.7703
        299.4853
        303.2312
        307.0083
        310.8166
        314.6563
        318.5275
        322.4303
        326.3648
        330.3313
        334.3297
        338.3603
        342.4231
        346.5183
        350.6461
        354.8065
        358.9997
        363.2257
        367.4849
        371.7771
        376.1027
        380.4617
        384.8543
        389.2805
        393.7406
        398.2345
        402.7626
        407.3248
        411.9214
        416.5524
        421.218
        425.9183
        430.6534
        435.4235
        440.2287
        445.0692
        449.9449
        454.8562
        459.803
        464.7856
        469.8041
        474.8586
        479.9492
        485.076
        490.2392
        495.4389
        500.6753
        505.9484
        511.2585
        516.6055
        521.9897
        527.4112
        532.8701
        538.3665
        543.9006
        549.4725
        555.0823
        560.7302
        566.4163
        572.1406
        577.9034
        583.7048
        589.5448
        595.4237
        601.3416
        607.2985
        613.2946
        619.3301
        625.405
        631.5196
        637.6738
        643.868
        650.1021
        656.3763
        662.6907
        669.0455
        675.4408
        681.8768
        688.3535
        694.871
        701.4296
        708.0294
        714.6703
        721.3527
        728.0767
    ]
    es = [
        -1201.1776527
        -1201.1792783
        -1201.180845
        -1201.1823535
        -1201.1838048
        -1201.1857092
        -1201.186542
        -1201.1878269
        -1201.1890616
        -1201.1906847
        -1201.1913795
        -1201.1924633
        -1201.1935021
        -1201.194493
        -1201.1954413
        -1201.1963445
        -1201.1975477
        -1201.1980347
        -1201.1988083
        -1201.1995541
        -1201.2002575
        -1201.2009258
        -1201.2015585
        -1201.2021556
        -1201.2028674
        -1201.2032521
        -1201.2037525
        -1201.2042232
        -1201.2046643
        -1201.2050747
        -1201.2054579
        -1201.2058132
        -1201.206143
        -1201.2064473
        -1201.2067259
        -1201.20698
        -1201.2072114
        -1201.2074353
        -1201.207606
        -1201.2077761
        -1201.2079159
        -1201.2080394
        -1201.2081438
        -1201.2082292
        -1201.2082962
        -1201.2083459
        -1201.2083783
        -1201.2083929
        -1201.2084741
        -1201.2083688
        -1201.2083404
        -1201.2082935
        -1201.208232
        -1201.2081564
        -1201.2081173
        -1201.2079657
        -1201.2078516
        -1201.2077239
        -1201.2075854
        -1201.2074633
        -1201.207274
        -1201.207102
        -1201.2069354
        -1201.2067294
        -1201.2065235
        -1201.2063119
        -1201.2060909
        -1201.2058612
        -1201.2056224
        -1201.2053821
        -1201.2051214
        -1201.2048592
        -1201.2045886
        -1201.2043109
        -1201.2039935
        -1201.2037374
        -1201.2034399
        -1201.2031357
        -1201.2028264
        -1201.2025196
        -1201.2021901
        -1201.2018636
        -1201.201532
        -1201.2011948
        -1201.200853
        -1201.2005083
        -1201.2001563
        -1201.199944
        -1201.1994441
        -1201.1990811
        -1201.1987147
        -1201.1983441
        -1201.1978577
        -1201.1975937
        -1201.1970935
        -1201.1968292
        -1201.1963133
        -1201.1960557
        -1201.1956647
        -1201.1952707
    ]
    @test isapprox(
        lsqfit(
            EnergyForm(),
            Murnaghan(224, 0.0006, 4, -323),
            vs,
            es,
        ) |> Collections.fieldvalues,
        Murnaghan(
            435.05782299050884,
            0.00028297159355249787,
            3.5705032675000785,
            -1201.2082739321822
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan2nd(224, 0.0006, -323),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan2nd(
            430.10027687726716,
            0.000302451215462375,
            -1201.2083221436026
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan3rd(224, 0.0006, 4, -323),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan3rd(
            432.67139080209046,
            0.00030508544859901674,
            3.7894868450211923,
            -1201.2083959943404
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan4th(432, 0.0003, 3.8, -5460, -1201),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan4th(
            432.8012195854224,
            0.0003041889904166284,
            3.774020919355492,
            -11773.192574765615,
            -1201.2083912308235
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            Vinet(432, 0.0003, 3.8, -1201),
            vs,
            es,
        ) |> Collections.fieldvalues,
        Vinet(
            432.04609865398015,
            0.0003137631070690569,
            3.837666939407128,
            -1201.2084453225773
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
end


@testset "`Test w2k-lda-k.dat` from `Gibbs2` with units" begin
    vs = [
        243.6753
        246.941
        250.2358
        253.5598
        256.9131
        260.2958
        263.7081
        267.1501
        270.6219
        274.1236
        277.6555
        281.2175
        284.8099
        288.4327
        292.0861
        295.7703
        299.4853
        303.2312
        307.0083
        310.8166
        314.6563
        318.5275
        322.4303
        326.3648
        330.3313
        334.3297
        338.3603
        342.4231
        346.5183
        350.6461
        354.8065
        358.9997
        363.2257
        367.4849
        371.7771
        376.1027
        380.4617
        384.8543
        389.2805
        393.7406
        398.2345
        402.7626
        407.3248
        411.9214
        416.5524
        421.218
        425.9183
        430.6534
        435.4235
        440.2287
        445.0692
        449.9449
        454.8562
        459.803
        464.7856
        469.8041
        474.8586
        479.9492
        485.076
        490.2392
        495.4389
        500.6753
        505.9484
        511.2585
        516.6055
        521.9897
        527.4112
        532.8701
        538.3665
        543.9006
        549.4725
        555.0823
        560.7302
        566.4163
        572.1406
        577.9034
        583.7048
        589.5448
        595.4237
        601.3416
        607.2985
        613.2946
        619.3301
        625.405
        631.5196
        637.6738
        643.868
        650.1021
        656.3763
        662.6907
        669.0455
        675.4408
        681.8768
        688.3535
        694.871
        701.4296
        708.0294
        714.6703
        721.3527
        728.0767
    ]
    es = [
        -1201.1776527
        -1201.1792783
        -1201.180845
        -1201.1823535
        -1201.1838048
        -1201.1857092
        -1201.186542
        -1201.1878269
        -1201.1890616
        -1201.1906847
        -1201.1913795
        -1201.1924633
        -1201.1935021
        -1201.194493
        -1201.1954413
        -1201.1963445
        -1201.1975477
        -1201.1980347
        -1201.1988083
        -1201.1995541
        -1201.2002575
        -1201.2009258
        -1201.2015585
        -1201.2021556
        -1201.2028674
        -1201.2032521
        -1201.2037525
        -1201.2042232
        -1201.2046643
        -1201.2050747
        -1201.2054579
        -1201.2058132
        -1201.206143
        -1201.2064473
        -1201.2067259
        -1201.20698
        -1201.2072114
        -1201.2074353
        -1201.207606
        -1201.2077761
        -1201.2079159
        -1201.2080394
        -1201.2081438
        -1201.2082292
        -1201.2082962
        -1201.2083459
        -1201.2083783
        -1201.2083929
        -1201.2084741
        -1201.2083688
        -1201.2083404
        -1201.2082935
        -1201.208232
        -1201.2081564
        -1201.2081173
        -1201.2079657
        -1201.2078516
        -1201.2077239
        -1201.2075854
        -1201.2074633
        -1201.207274
        -1201.207102
        -1201.2069354
        -1201.2067294
        -1201.2065235
        -1201.2063119
        -1201.2060909
        -1201.2058612
        -1201.2056224
        -1201.2053821
        -1201.2051214
        -1201.2048592
        -1201.2045886
        -1201.2043109
        -1201.2039935
        -1201.2037374
        -1201.2034399
        -1201.2031357
        -1201.2028264
        -1201.2025196
        -1201.2021901
        -1201.2018636
        -1201.201532
        -1201.2011948
        -1201.200853
        -1201.2005083
        -1201.2001563
        -1201.199944
        -1201.1994441
        -1201.1990811
        -1201.1987147
        -1201.1983441
        -1201.1978577
        -1201.1975937
        -1201.1970935
        -1201.1968292
        -1201.1963133
        -1201.1960557
        -1201.1956647
        -1201.1952707
    ]
    volumes = vs .* u"bohr^3"
    energies = es .* u"Ry"
    fitted_eos = lsqfit(
        EnergyForm(),
        BirchMurnaghan3rd(224 * u"bohr^3", 0.0006 * u"Ry/bohr^3", 4, -323 * u"Ry"),
        volumes,
        energies,
    )
    @test ustrip.(fitted_eos |> Collections.fieldvalues) ≈
    ustrip.(
        BirchMurnaghan3rd(
            432.6713907942206 * u"bohr^3",
            0.00030508544829126676 * u"Ry/bohr^3",
            3.789486849598267,
            -1201.208395994332 * u"Ry",
        ) |> Collections.fieldvalues
    )
    @test ustrip.(
        lsqfit(EnergyForm(), BirchMurnaghan3rd(224u"bohr^3", 10u"GPa", 3.75, -161u"hartree"), volumes, energies) |> Collections.fieldvalues
    ) ≈
    ustrip.(
        BirchMurnaghan3rd(432.671390388525u"bohr^3", 4.487961877912739u"GPa", 3.7894868798185493, -600.6041979971637u"hartree") |> Collections.fieldvalues
    )
end

@testset "`Test mgo-sety1.dat` from `Gibbs2`" begin
    vs = [
        71.51955637984702
        72.0783029140629
        72.63704944827879
        73.19579598249467
        73.75454251671056
        74.31328905092643
        74.87203558514231
        75.4307821193582
        75.98952865357408
        76.54827518778997
        77.10702172200585
        77.66576825622174
        78.22451479043761
        78.7832613246535
        79.34200785886938
        79.90075439308526
        80.45950092730115
        81.01824746151703
        81.57699399573292
        82.1357405299488
        82.69448706416469
        83.25323359838056
        83.81198013259645
        84.37072666681233
        84.92947320102822
        85.4882197352441
        86.04696626945999
        86.60571280367587
        87.16445933789174
        87.72320587210763
        88.28195240632351
        88.8406989405394
        89.39944547475528
        89.95819200897117
        90.51693854318705
        91.07568507740294
        91.63443161161882
        92.19317814583471
        92.75192468005058
        93.31067121426646
        93.86941774848235
        94.42816428269823
        94.98691081691412
        95.54565735112999
        96.10440388534587
        96.66315041956176
        97.22189695377764
        97.78064348799353
        98.33939002220941
        98.8981365564253
        99.45688309064118
        100.01562962485707
        100.57437615907295
        101.13312269328884
        101.69186922750471
        102.2506157617206
        102.80936229593648
        103.36810883015237
        103.92685536436825
        104.48560189858412
        105.0443484328
        105.60309496701589
        106.16184150123178
        106.72058803544766
        107.27933456966355
        107.83808110387943
        108.39682763809532
        108.9555741723112
        109.51432070652709
        110.07306724074297
        110.63181377495884
        111.19056030917473
        111.74930684339061
        112.3080533776065
        112.86679991182238
        113.42554644603825
        113.98429298025414
        114.54303951447002
        115.10178604868591
        115.6605325829018
        116.21927911711768
        116.77802565133356
        117.33677218554945
        117.89551871976533
        118.45426525398122
        119.0130117881971
        119.57175832241298
        120.13050485662886
        120.68925139084475
        121.24799792506063
        121.80674445927652
        122.36549099349239
        122.92423752770827
        123.48298406192416
        124.04173059614004
        124.60047713035593
        125.15922366457181
        125.7179701987877
        126.27671673300358
        126.83546326721947
        127.39420980143535
        127.95295633565124
        128.51170286986712
        129.07044940408298
        129.6291959382989
        130.18794247251475
        130.74668900673066
        131.30543554094652
        131.8641820751624
        132.4229286093783
        132.98167514359417
        133.54042167781006
        134.09916821202594
        134.65791474624183
        135.2166612804577
        135.7754078146736
        136.33415434888948
        136.89290088310537
        137.45164741732123
        138.01039395153714
        138.569140485753
        139.1278870199689
        139.68663355418477
        140.24538008840068
        140.80412662261654
        141.36287315683242
        141.9216196910483
        142.4803662252642
        143.03911275948008
    ]
    es = [
        -34.00775398
        -34.0190082
        -34.02992647
        -34.04052022
        -34.05079922
        -34.06077277
        -34.0704506
        -34.07984653
        -34.08896085
        -34.0978042
        -34.10638855
        -34.11471583
        -34.12279583
        -34.13063609
        -34.13824518
        -34.1456268
        -34.15279001
        -34.15973876
        -34.16647895
        -34.1730202
        -34.17936412
        -34.18551683
        -34.19148806
        -34.19727555
        -34.20288898
        -34.20833138
        -34.21360745
        -34.21872393
        -34.2236828
        -34.22849177
        -34.23315234
        -34.23766788
        -34.24204214
        -34.24627838
        -34.25038459
        -34.25435835
        -34.25820545
        -34.26193399
        -34.26553901
        -34.2690287
        -34.27240614
        -34.27566932
        -34.27882789
        -34.28188043
        -34.28483105
        -34.28768098
        -34.29043394
        -34.29309257
        -34.29565801
        -34.29813575
        -34.30052413
        -34.30282697
        -34.30504676
        -34.30718589
        -34.30924656
        -34.31123046
        -34.31313623
        -34.31496818
        -34.31673139
        -34.31842177
        -34.32004585
        -34.32160156
        -34.32309155
        -34.32451965
        -34.32588527
        -34.32719027
        -34.32844001
        -34.32962806
        -34.3307603
        -34.33183713
        -34.33286456
        -34.33383534
        -34.33475519
        -34.33562709
        -34.33644925
        -34.33722484
        -34.3379529
        -34.33863669
        -34.33927612
        -34.33987151
        -34.34042433
        -34.3409375
        -34.34140944
        -34.3418419
        -34.34223621
        -34.34259266
        -34.34291588
        -34.34320277
        -34.34345231
        -34.34366646
        -34.34384815
        -34.34399664
        -34.3441149
        -34.34420115
        -34.34425594
        -34.34428195
        -34.34427761
        -34.34424807
        -34.34418868
        -34.34410162
        -34.34398884
        -34.34385192
        -34.34368896
        -34.3434993
        -34.34328585
        -34.34305126
        -34.34279123
        -34.34250948
        -34.34220541
        -34.34187944
        -34.34153303
        -34.34116878
        -34.34078072
        -34.34037385
        -34.33994687
        -34.33950111
        -34.33903726
        -34.33855599
        -34.33805699
        -34.33754037
        -34.33700777
        -34.33645907
        -34.33589553
        -34.33531772
        -34.33472332
        -34.33411208
        -34.33348704
        -34.33284619
        -34.33219292
    ]
    @test isapprox(
        lsqfit(
            EnergyForm(),
            Murnaghan(110, 0.01, 4, -34),
            vs,
            es,
        ) |> Collections.fieldvalues,
        Murnaghan(
            124.88539638285143,
            0.012047999390789954,
            3.505337379827799,
            -34.34458025509868
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan2nd(124, 0.012, -34),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan2nd(
            124.60346122403192,
            0.0119478059177848,
            -34.344520503316495
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan3rd(110, 0.01, 4, -34),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan3rd(
            124.82366127014902,
            0.011559181270548115,
            4.115715176896173,
            -34.344311191717864
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan4th(124, 0.01, 4, -5300, -34),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan4th(
            124.82134004287863,
            0.011506626229629386,
            4.171189921447817,
            -373.8291670908353,
            -34.34428288861632
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            Vinet(124, 0.01, 4, -34),
            vs,
            es,
        ) |> Collections.fieldvalues,
        Vinet(
            124.78343088049905,
            0.011244915521226076,
            4.5244363120324955,
            -34.344139097248
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
end

@testset "`Test mgo-sety1.dat` from `Gibbs2` with units" begin
    vs = [
        71.51955637984702
        72.0783029140629
        72.63704944827879
        73.19579598249467
        73.75454251671056
        74.31328905092643
        74.87203558514231
        75.4307821193582
        75.98952865357408
        76.54827518778997
        77.10702172200585
        77.66576825622174
        78.22451479043761
        78.7832613246535
        79.34200785886938
        79.90075439308526
        80.45950092730115
        81.01824746151703
        81.57699399573292
        82.1357405299488
        82.69448706416469
        83.25323359838056
        83.81198013259645
        84.37072666681233
        84.92947320102822
        85.4882197352441
        86.04696626945999
        86.60571280367587
        87.16445933789174
        87.72320587210763
        88.28195240632351
        88.8406989405394
        89.39944547475528
        89.95819200897117
        90.51693854318705
        91.07568507740294
        91.63443161161882
        92.19317814583471
        92.75192468005058
        93.31067121426646
        93.86941774848235
        94.42816428269823
        94.98691081691412
        95.54565735112999
        96.10440388534587
        96.66315041956176
        97.22189695377764
        97.78064348799353
        98.33939002220941
        98.8981365564253
        99.45688309064118
        100.01562962485707
        100.57437615907295
        101.13312269328884
        101.69186922750471
        102.2506157617206
        102.80936229593648
        103.36810883015237
        103.92685536436825
        104.48560189858412
        105.0443484328
        105.60309496701589
        106.16184150123178
        106.72058803544766
        107.27933456966355
        107.83808110387943
        108.39682763809532
        108.9555741723112
        109.51432070652709
        110.07306724074297
        110.63181377495884
        111.19056030917473
        111.74930684339061
        112.3080533776065
        112.86679991182238
        113.42554644603825
        113.98429298025414
        114.54303951447002
        115.10178604868591
        115.6605325829018
        116.21927911711768
        116.77802565133356
        117.33677218554945
        117.89551871976533
        118.45426525398122
        119.0130117881971
        119.57175832241298
        120.13050485662886
        120.68925139084475
        121.24799792506063
        121.80674445927652
        122.36549099349239
        122.92423752770827
        123.48298406192416
        124.04173059614004
        124.60047713035593
        125.15922366457181
        125.7179701987877
        126.27671673300358
        126.83546326721947
        127.39420980143535
        127.95295633565124
        128.51170286986712
        129.07044940408298
        129.6291959382989
        130.18794247251475
        130.74668900673066
        131.30543554094652
        131.8641820751624
        132.4229286093783
        132.98167514359417
        133.54042167781006
        134.09916821202594
        134.65791474624183
        135.2166612804577
        135.7754078146736
        136.33415434888948
        136.89290088310537
        137.45164741732123
        138.01039395153714
        138.569140485753
        139.1278870199689
        139.68663355418477
        140.24538008840068
        140.80412662261654
        141.36287315683242
        141.9216196910483
        142.4803662252642
        143.03911275948008
    ]
    es = [
        -34.00775398
        -34.0190082
        -34.02992647
        -34.04052022
        -34.05079922
        -34.06077277
        -34.0704506
        -34.07984653
        -34.08896085
        -34.0978042
        -34.10638855
        -34.11471583
        -34.12279583
        -34.13063609
        -34.13824518
        -34.1456268
        -34.15279001
        -34.15973876
        -34.16647895
        -34.1730202
        -34.17936412
        -34.18551683
        -34.19148806
        -34.19727555
        -34.20288898
        -34.20833138
        -34.21360745
        -34.21872393
        -34.2236828
        -34.22849177
        -34.23315234
        -34.23766788
        -34.24204214
        -34.24627838
        -34.25038459
        -34.25435835
        -34.25820545
        -34.26193399
        -34.26553901
        -34.2690287
        -34.27240614
        -34.27566932
        -34.27882789
        -34.28188043
        -34.28483105
        -34.28768098
        -34.29043394
        -34.29309257
        -34.29565801
        -34.29813575
        -34.30052413
        -34.30282697
        -34.30504676
        -34.30718589
        -34.30924656
        -34.31123046
        -34.31313623
        -34.31496818
        -34.31673139
        -34.31842177
        -34.32004585
        -34.32160156
        -34.32309155
        -34.32451965
        -34.32588527
        -34.32719027
        -34.32844001
        -34.32962806
        -34.3307603
        -34.33183713
        -34.33286456
        -34.33383534
        -34.33475519
        -34.33562709
        -34.33644925
        -34.33722484
        -34.3379529
        -34.33863669
        -34.33927612
        -34.33987151
        -34.34042433
        -34.3409375
        -34.34140944
        -34.3418419
        -34.34223621
        -34.34259266
        -34.34291588
        -34.34320277
        -34.34345231
        -34.34366646
        -34.34384815
        -34.34399664
        -34.3441149
        -34.34420115
        -34.34425594
        -34.34428195
        -34.34427761
        -34.34424807
        -34.34418868
        -34.34410162
        -34.34398884
        -34.34385192
        -34.34368896
        -34.3434993
        -34.34328585
        -34.34305126
        -34.34279123
        -34.34250948
        -34.34220541
        -34.34187944
        -34.34153303
        -34.34116878
        -34.34078072
        -34.34037385
        -34.33994687
        -34.33950111
        -34.33903726
        -34.33855599
        -34.33805699
        -34.33754037
        -34.33700777
        -34.33645907
        -34.33589553
        -34.33531772
        -34.33472332
        -34.33411208
        -34.33348704
        -34.33284619
        -34.33219292
    ]
    volumes = vs .* u"angstrom^3"
    energies = es .* u"Ry"
    fitted_eos = lsqfit(
        EnergyForm(),
        BirchMurnaghan3rd(110 * u"angstrom^3", 0.01 * u"Ry/angstrom^3", 4, -34 * u"Ry"),
        volumes,
        energies,
    )
    @test ustrip.(fitted_eos |> Collections.fieldvalues) ≈
    ustrip.(
        BirchMurnaghan3rd(
            124.82366127026123 * u"angstrom^3",
            0.011559181270413301 * u"Ry/angstrom^3",
            4.1157151769280995,
            -34.34431119171783 * u"Ry",
        ) |> Collections.fieldvalues
    )
    @test ustrip.(
        lsqfit(EnergyForm(), BirchMurnaghan3rd(124u"angstrom^3", 20u"GPa", 4, -17u"hartree"), volumes, energies) |> Collections.fieldvalues
    ) ≈
    ustrip.(
        BirchMurnaghan3rd(124.82366126764893u"angstrom^3", 25.19753977636424u"GPa", 4.115715175957134, -17.172155595859646u"hartree") |> Collections.fieldvalues
    )
end

@testset "`Test test01a.dat` from `Gibbs2`" begin
    vs = [
        31.5176
        32.4533
        33.4073
        34.3799
        35.3711
        36.3812
        37.4103
        38.4587
        39.5265
        40.6139
        41.721
        42.8481
        43.9952
        45.1627
        46.3507
        47.5593
        48.7887
        50.0392
        51.3108
        52.6038
        53.9183
        55.2545
        56.6127
        57.9929
        59.3954
        60.8203
        62.2678
        63.7381
        65.2313
        66.7478
        68.2875
        69.8507
        71.4376
        73.0484
        74.6832
        76.3421
        78.0255
        79.7335
        81.4662
        83.2238
        85.0065
        86.8145
        88.648
        90.5071
        92.392
        94.3029
        96.2399
        98.2033
        100.1932
        102.2099
        104.2534
        106.3239
        108.4217
        110.547
        112.6998
        114.8803
        117.0889
        119.3255
        121.5905
        123.8839
        126.206
        128.5569
        130.9369
        133.346
        135.7845
        138.2526
        140.7504
        143.2781
        145.8358
        148.4239
        151.0423
        153.6914
        156.3713
        159.0822
        161.8242
        164.5975
        167.4024
        170.2389
        173.1073
        176.0077
        178.9404
        181.9054
        184.903
        187.9334
        190.9967
        194.0931
        197.2228
        200.386
        203.5828
        206.8134
        210.078
        213.3768
        216.71
        220.0777
        223.4801
        226.9174
        230.3897
        233.8973
        237.4403
        241.0189
        244.6333
        248.2837
        251.9701
    ]
    es = [
        -14.5664202
        -14.5804702
        -14.5938196
        -14.6065011
        -14.618562
        -14.6300054
        -14.640879
        -14.6512193
        -14.6610287
        -14.670344
        -14.6792001
        -14.687601
        -14.695594
        -14.703158
        -14.7103533
        -14.717181
        -14.723658
        -14.7298098
        -14.7356349
        -14.7411619
        -14.7463919
        -14.7513556
        -14.7560566
        -14.7605144
        -14.7647283
        -14.7687083
        -14.7724766
        -14.7760428
        -14.7793983
        -14.7825746
        -14.7855695
        -14.7883851
        -14.7910427
        -14.7935382
        -14.7958923
        -14.7980946
        -14.8001569
        -14.8020929
        -14.8039003
        -14.8055857
        -14.8071605
        -14.8086231
        -14.8099792
        -14.8112335
        -14.8123882
        -14.8134524
        -14.8144362
        -14.8153196
        -14.8161318
        -14.8168626
        -14.8175204
        -14.8181053
        -14.8186225
        -14.8190725
        -14.8194614
        -14.8197917
        -14.8200626
        -14.820278
        -14.8204398
        -14.8205529
        -14.8206173
        -14.8206353
        -14.8206092
        -14.8205405
        -14.8204307
        -14.820282
        -14.8200967
        -14.8198746
        -14.8196193
        -14.819331
        -14.8190113
        -14.818666
        -14.8182878
        -14.8178823
        -14.8174505
        -14.816994
        -14.8165098
        -14.8160064
        -14.8154811
        -14.8149353
        -14.8143691
        -14.8137844
        -14.8131807
        -14.8125612
        -14.8119241
        -14.8112717
        -14.8106045
        -14.8099231
        -14.8092275
        -14.8085189
        -14.8077991
        -14.807068
        -14.8063242
        -14.8055711
        -14.8048086
        -14.8040364
        -14.8032545
        -14.802466
        -14.8016672
        -14.8008634
        -14.8000517
        -14.7992338
        -14.7984082
    ]
    @test isapprox(
        lsqfit(
            EnergyForm(),
            Murnaghan(132, 0.01, 3.68, -14),
            vs,
            es,
        ) |> Collections.fieldvalues,
        Murnaghan(
            132.9174710492377,
            0.000997071972650323,
            2.6506133298092553,
            -14.821067528760938
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan2nd(132, 0.01, -14),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan2nd(
            130.7191505712864,
            0.000706623449967504,
            -14.817402887854884
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan3rd(128, 0.03, 4, -14),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan3rd(
            126.49515516259525,
            0.0010084167615290376,
            3.679199350825455,
            -14.820223865421232
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            BirchMurnaghan4th(128, 0.03, 4, -320, -14),
            vs,
            es,
        ) |> Collections.fieldvalues,
        BirchMurnaghan4th(
            127.67097934611786,
            0.001041910691949355,
            3.463365305040609,
            -3214.0364009441837,
            -14.820651678910448
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
    @test isapprox(
        lsqfit(
            EnergyForm(),
            Vinet(128, 0.03, 4, -14),
            vs,
            es,
        ) |> Collections.fieldvalues,
        Vinet(
            124.71725873851614,
            0.001064866793589798,
            3.905491499988182,
            -14.820340399744088
        ) |> Collections.fieldvalues;
        atol = 1e-3,
    )
end

@testset "`Test test01a.dat` from `Gibbs2` with units" begin
    vs = [
        31.5176
        32.4533
        33.4073
        34.3799
        35.3711
        36.3812
        37.4103
        38.4587
        39.5265
        40.6139
        41.721
        42.8481
        43.9952
        45.1627
        46.3507
        47.5593
        48.7887
        50.0392
        51.3108
        52.6038
        53.9183
        55.2545
        56.6127
        57.9929
        59.3954
        60.8203
        62.2678
        63.7381
        65.2313
        66.7478
        68.2875
        69.8507
        71.4376
        73.0484
        74.6832
        76.3421
        78.0255
        79.7335
        81.4662
        83.2238
        85.0065
        86.8145
        88.648
        90.5071
        92.392
        94.3029
        96.2399
        98.2033
        100.1932
        102.2099
        104.2534
        106.3239
        108.4217
        110.547
        112.6998
        114.8803
        117.0889
        119.3255
        121.5905
        123.8839
        126.206
        128.5569
        130.9369
        133.346
        135.7845
        138.2526
        140.7504
        143.2781
        145.8358
        148.4239
        151.0423
        153.6914
        156.3713
        159.0822
        161.8242
        164.5975
        167.4024
        170.2389
        173.1073
        176.0077
        178.9404
        181.9054
        184.903
        187.9334
        190.9967
        194.0931
        197.2228
        200.386
        203.5828
        206.8134
        210.078
        213.3768
        216.71
        220.0777
        223.4801
        226.9174
        230.3897
        233.8973
        237.4403
        241.0189
        244.6333
        248.2837
        251.9701
    ]
    es = [
        -14.5664202
        -14.5804702
        -14.5938196
        -14.6065011
        -14.618562
        -14.6300054
        -14.640879
        -14.6512193
        -14.6610287
        -14.670344
        -14.6792001
        -14.687601
        -14.695594
        -14.703158
        -14.7103533
        -14.717181
        -14.723658
        -14.7298098
        -14.7356349
        -14.7411619
        -14.7463919
        -14.7513556
        -14.7560566
        -14.7605144
        -14.7647283
        -14.7687083
        -14.7724766
        -14.7760428
        -14.7793983
        -14.7825746
        -14.7855695
        -14.7883851
        -14.7910427
        -14.7935382
        -14.7958923
        -14.7980946
        -14.8001569
        -14.8020929
        -14.8039003
        -14.8055857
        -14.8071605
        -14.8086231
        -14.8099792
        -14.8112335
        -14.8123882
        -14.8134524
        -14.8144362
        -14.8153196
        -14.8161318
        -14.8168626
        -14.8175204
        -14.8181053
        -14.8186225
        -14.8190725
        -14.8194614
        -14.8197917
        -14.8200626
        -14.820278
        -14.8204398
        -14.8205529
        -14.8206173
        -14.8206353
        -14.8206092
        -14.8205405
        -14.8204307
        -14.820282
        -14.8200967
        -14.8198746
        -14.8196193
        -14.819331
        -14.8190113
        -14.818666
        -14.8182878
        -14.8178823
        -14.8174505
        -14.816994
        -14.8165098
        -14.8160064
        -14.8154811
        -14.8149353
        -14.8143691
        -14.8137844
        -14.8131807
        -14.8125612
        -14.8119241
        -14.8112717
        -14.8106045
        -14.8099231
        -14.8092275
        -14.8085189
        -14.8077991
        -14.807068
        -14.8063242
        -14.8055711
        -14.8048086
        -14.8040364
        -14.8032545
        -14.802466
        -14.8016672
        -14.8008634
        -14.8000517
        -14.7992338
        -14.7984082
    ]
    volumes = vs .* u"bohr^3"
    energies = es .* u"Ry"
    fitted_eos = lsqfit(
        EnergyForm(),
        BirchMurnaghan3rd(128 * u"bohr^3", 0.03 * u"Ry/bohr^3", 4, -14 * u"Ry"),
        volumes,
        energies,
    )
    @test ustrip.(fitted_eos |> Collections.fieldvalues) ≈
    ustrip.(
        BirchMurnaghan3rd(
            126.49515516270048 * u"bohr^3",
            0.001008416761528213 * u"Ry/bohr^3",
            3.6791993508231235,
            -14.820223865421246 * u"Ry",
        ) |> Collections.fieldvalues
    )
    @test ustrip.(
        lsqfit(EnergyForm(), BirchMurnaghan3rd(128u"bohr^3", 44u"GPa", 4, -14u"hartree"), volumes, energies) |> Collections.fieldvalues
    ) ≈
    ustrip.(
        BirchMurnaghan3rd(126.49515516262232u"bohr^3", 14.834322684855008u"GPa", 3.679199350823988, -7.410111932710624u"hartree") |> Collections.fieldvalues
    )
end